////////////////////////////////////////////////////||
// ROB KANDEL  										||
// kandelrob@gmail.com								||
// 													||
// created 07.09.15	| updated 07.16.15				||
// app.min.js										||
// version 0.0.4									||
////////////////////////////////////////////////////||

var _septa=(function(){var n=[{value:"1",label:"1"},{value:"2",label:"2"},{value:"3",label:"3"},{value:"4",label:"4"},{value:"5",label:"5"},{value:"6",label:"6"},{value:"7",label:"7"},{value:"8",label:"8"},{value:"9",label:"9"},{value:"12",label:"12"},{value:"14",label:"14"},{value:"17",label:"17"},{value:"18",label:"18"},{value:"19",label:"19"},{value:"20",label:"20"},{value:"21",label:"21"},{value:"22",label:"22"},{value:"23",label:"23"},{value:"24",label:"24"},{value:"25",label:"25"},{value:"26",label:"26"},{value:"27",label:"27"},{value:"28",label:"28"},{value:"29",label:"29"},{value:"30",label:"30"},{value:"31",label:"31"},{value:"32",label:"32"},{value:"33",label:"33"},{value:"35",label:"35"},{value:"37",label:"37"},{value:"38",label:"38"},{value:"39",label:"39"},{value:"40",label:"40"},{value:"42",label:"42"},{value:"43",label:"43"},{value:"44",label:"44"},{value:"46",label:"46"},{value:"47",label:"47"},{value:"48",label:"48"},{value:"50",label:"50"},{value:"52",label:"52"},{value:"53",label:"53"},{value:"54",label:"54"},{value:"55",label:"55"},{value:"56",label:"56"},{value:"57",label:"57"},{value:"58",label:"58"},{value:"59",label:"59"},{value:"60",label:"60"},{value:"61",label:"61"},{value:"62",label:"62"},{value:"64",label:"64"},{value:"65",label:"65"},{value:"66",label:"66"},{value:"67",label:"67"},{value:"68",label:"68"},{value:"70",label:"70"},{value:"73",label:"73"},{value:"75",label:"75"},{value:"77",label:"77"},{value:"78",label:"78"},{value:"79",label:"79"},{value:"80",label:"80"},{value:"84",label:"84"},{value:"88",label:"88"},{value:"89",label:"89"},{value:"C",label:"C"},{value:"G",label:"G"},{value:"HXH",label:"HXH"},{value:"J",label:"J"},{value:"K",label:"K"},{value:"L",label:"L"},{value:"R",label:"R"},{value:"LUCY",label:"LUCY"},{value:"90",label:"90"},{value:"91",label:"91"},{value:"92",label:"92"},{value:"93",label:"93"},{value:"94",label:"94"},{value:"95",label:"95"},{value:"96",label:"96"},{value:"97",label:"97"},{value:"98",label:"98"},{value:"99",label:"99"},{value:"103",label:"103"},{value:"104",label:"104"},{value:"105",label:"105"},{value:"106",label:"106"},{value:"107",label:"107"},{value:"108",label:"108"},{value:"109",label:"109"},{value:"110",label:"110"},{value:"111",label:"111"},{value:"112",label:"112"},{value:"113",label:"113"},{value:"114",label:"114"},{value:"115",label:"115"},{value:"116",label:"116"},{value:"117",label:"117"},{value:"118",label:"118"},{value:"119",label:"119"},{value:"120",label:"120"},{value:"123",label:"123"},{value:"124",label:"124"},{value:"125",label:"125"},{value:"126",label:"126"},{value:"127",label:"127"},{value:"128",label:"128"},{value:"129",label:"129"},{value:"130",label:"130"},{value:"131",label:"131"},{value:"132",label:"132"},{value:"133",label:"133"},{value:"134",label:"134"},{value:"139",label:"139"},{value:"150",label:"150"},{value:"201",label:"201"},{value:"204",label:"204"},{value:"205",label:"205"},{value:"206",label:"206"},{value:"310",label:"310"},{value:"airport",label:"Airport"},{value:"chestnut-h-east",label:"Chestnut Hill East"},{value:"chestnut-h-west",label:"chestnut Hill West"},{value:"doylestown",label:"Doylestown"},{value:"elwyn",label:"Elwyn"},{value:"fox-chase",label:"Fox Chase"},{value:"malvern",label:"Malvern"},{value:"marcus-hook",label:"Marcus Hook"},{value:"norristown",label:"Norristown"},{value:"paoli",label:"Paoli"},{value:"temple-u",label:"Temple U"},{value:"thorndale",label:"Thorndale"},{value:"trenton",label:"Trenton"},{value:"warminster",label:"Warminster"},{value:"west-trenton",label:"West Trenton"},{value:"wilmington",label:"Wilmington"},{value:"10",label:"10"},{value:"11",label:"11"},{value:"13",label:"13"},{value:"15",label:"15"},{value:"34",label:"34"},{value:"36",label:"36"},{value:"101",label:"101"},{value:"102",label:"102"}],o=["1","2","3","4","5","6","7","8","9","12","14","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","35","37","38","39","40","42","43","44","46","47","48","50","52","53","54","55","56","57","58","59","60","61","62","64","65","66","67","68","70","73","75","77","78","79","80","84","88","89","C","G","HXH","J","K","L","R","LUCY","90","91","92","93","94","95","96","97","98","99","103","104","105","106","107","108","109","110","111","112","113","114","115","116","117","118","119","120","123","124","125","126","127","128","129","130","131","132","133","134","139","150","201","204","205","206","310"],h=["airport","chestnut-h-east","chestnut-h-west","doylestown","elwyn","fox-chase","malvern","marcus-hook","norristown","paoli","temple-u","thorndale","trenton","warminster","west-trenton","wilmington"],p=["10","11","13","15","34","36","101","102"],d=[],c,j=[],m,g,q,e,r,b,a="",f=false,l=null,k=false;method={init:function(){jQuery("#menu_wrapper").on("click",function(){if(l!=null){clearTimeout(b);if(jQuery("#timer").data("pietimer")){jQuery("#timer").pietimer("reset")}}if(jQuery(this).hasClass("menuWrapperActive")){if(l!=null){jQuery(this).removeClass("menuWrapperActive");jQuery(".preloaderWrapper").hide();jQuery(".searchWrapper").hide()}}else{jQuery(this).addClass("menuWrapperActive");jQuery(".preloaderWrapper").hide();jQuery(".searchWrapper").show()}});if(method.url_anchor("route")==""){jQuery(".preloaderWrapper").hide();jQuery(".searchWrapper").show()}else{jQuery("#route_name").val(method.url_anchor("route"));k=true;jQuery("#route_search").find("button").prop("disabled",false);method.get_data.find_route_type(jQuery("#route_name").val(),false)}method.pick_location();method.map.start_map()},url_parameter:function(t){var u=decodeURI(window.location.search.substring(1));var v=u.split("&");for(var s=0;s<v.length;s++){if(t==v[s].split("=")[0]){return v[s].split("=")[1]}}return""},url_anchor:function(t){var s=window.location.href;var u=s.indexOf("#");return u!=-1?s.substring(u+1).split(t+"=")[1]:""},update_anchor_tag:function(u){var s=window.location.href;var t=s.indexOf("#");window.location.hash=(u!=null)?("#route="+u):""},pick_location:function(){jQuery("#search_type_route").on("click",function(){jQuery("#search_holder_route").slideDown(150);jQuery("#search_holder_find").slideUp(150);jQuery(this).addClass("btn-success").removeClass("btn-default");jQuery("#search_type_find").removeClass("btn-success").addClass("btn-default")});jQuery("#search_type_find").on("click",function(){jQuery("#search_holder_route").slideUp(150);jQuery("#search_holder_find").slideDown(150);jQuery(this).addClass("btn-success").removeClass("btn-default");jQuery("#search_type_route").removeClass("btn-success").addClass("btn-default")});jQuery("#route_name").autocomplete({source:n,minLength:0,focus:function(s,t){jQuery("#route_name").val(t.item.label);return false},select:function(s,t){jQuery("#route_name").val(t.item.value);jQuery("#route_search").find("button").prop("disabled",false);jQuery("#route_search").click();return false}}).on("input",function(){(jQuery("#route_name").val().length>=1)?jQuery("#route_search").find("button").prop("disabled",false):jQuery("#route_search").find("button").prop("disabled",true)}).on("keydown",function(s){if(s.keyCode==13){if(jQuery("#route_name").val().length>=1&&jQuery("#route_name").val()!=l){jQuery("#route_search").click()}}}).focus(function(){jQuery(this).trigger("keydown.autocomplete")});jQuery("#route_search").on("click",function(){k=true;method.get_data.find_route_type(jQuery("#route_name").val(),true)});jQuery(".showRouteButton").on("click",function(){jQuery(".showRouteTypes").slideDown(150);jQuery(".inputWrapper").slideUp(150);jQuery(".showRouteButton").slideUp(150)});method.start_carousel($("#bus_routes"),"bus");jQuery(".routeTypeButton").each(function(){jQuery(this).on("click",function(){var t=jQuery(".routeTypeButtonWrapper").find(".btn-primary");t.removeClass("btn-primary").addClass("btn-default");jQuery(this).removeClass(".btn-default").addClass("btn-primary");jQuery(".routeNumber").slideUp(150);jQuery("#"+jQuery(this).attr("id").split("route_type_")[1]+"_routes").slideDown(150);var s=jQuery("#"+t.attr("id").split("route_type_")[1]+"_routes").data("owlCarousel");s.destroy();method.start_carousel(jQuery("#"+jQuery(this).attr("id").split("route_type_")[1]+"_routes"),jQuery(this).attr("id").split("route_type_")[1])})});jQuery(".myLocationButton").on("click",function(){jQuery(".preloaderWrapper").show();jQuery(".searchWrapper").hide();jQuery("#menu_wrapper").removeClass("menuWrapperActive");if(navigator.geolocation){navigator.geolocation.getCurrentPosition(_septa.return_coords)}else{alert("Geolocation is not supported by this browser");jQuery(".preloaderWrapper").hide();jQuery(".searchWrapper").show()}});jQuery("#geocode_input").on("input",function(){(jQuery("#geocode_input").val().length>=1)?jQuery("#geocode_search").find("button").prop("disabled",false):jQuery("#geocode_search").find("button").prop("disabled",true)}).on("keydown",function(s){if(s.keyCode==13){if(jQuery("#geocode_input").val().length>=1){jQuery("#geocode_search").click()}}});jQuery("#geocode_search").on("click",function(){if(jQuery("#geocode_input").val().length>=1){method.geocode.google(jQuery("#geocode_input").val())}})},return_coords:function(s){if("latitude" in s.coords&&"longitude" in s.coords){method.get_data.find_stations(s.coords.latitude,s.coords.longitude)}else{alert("Something went wrong, try typing your address");jQuery(".preloaderWrapper").hide();jQuery(".searchWrapper").show()}},start_carousel:function(u,t){var s=u;s.owlCarousel({items:((t=="train")?2:8),responsive:false});u.find(".item").each(function(){jQuery(this).unbind("click");jQuery(this).on("click",function(){jQuery(".showRouteTypes").slideUp(150);jQuery(".inputWrapper").slideDown(150);jQuery(".showRouteButton").slideDown(150);jQuery("#route_name").val(jQuery(this).attr("data-value"));jQuery("#route_search").click()})})},map:{start_map:function(){c=L.map("the_map",{center:[39.952474,-75.16359],zoom:12,detectRetina:true});var s=L.tileLayer("http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'}).addTo(c)},add_points:function(z,A){g=new L.LayerGroup();q=new L.LayerGroup();g.clearLayers();q.clearLayers();j=[];var v=L.Icon.extend({options:{iconSize:[25,41],shadowSize:[41,41],iconAnchor:[12.5,41],shadowAnchor:[12.5,41],popupAnchor:[0,-33],shadowUrl:"icons/marker-shadow.png",shadowRetinaUrl:"icons/marker-shadow@2x.png",shadowSize:[41,41]}}),E=new v({iconUrl:"icons/bus_blue.png",iconRetinaUrl:"icons/bus_blue@2x.png"}),s=new v({iconUrl:"icons/bus_orange.png",iconRetinaUrl:"icons/bus_orange@2x.png"}),x=new v({iconUrl:"icons/train_blue.png",iconRetinaUrl:"icons/train_blue@2x.png"}),y=new v({iconUrl:"icons/train_orange.png",iconRetinaUrl:"icons/train_orange@2x.png"}),u=new v({iconUrl:"icons/trolley_blue.png",iconRetinaUrl:"icons/trolley_blue@2x.png"}),w=new v({iconUrl:"icons/trolley_green.png",iconRetinaUrl:"icons/trolley_green@2x.png"}),D=new L.LatLngBounds(),B=((A=="bus"||A=="trolley")?"bus":"train");for(i in z[B]){var C=L.marker([z[B][i].lat,((A=="bus"||A=="trolley")?z[B][i].lng:z[B][i].lon)],{id:i,icon:((A=="train")?x:((z[B][i].Direction.toLowerCase()=="northbound"||z[B][i].Direction.toLowerCase()=="westbound")?((A=="bus")?E:x):((A=="bus")?s:y)))}),t=new L.LatLng(parseFloat(z[B][i].lat),parseFloat(((A=="bus"||A=="trolley")?z[B][i].lng:z[B][i].lon)));if(A=="bus"||A=="trolley"){(z[B][i].Direction.toLowerCase()=="northbound"||z[B][i].Direction.toLowerCase()=="westbound")?g.addLayer(C):q.addLayer(C);D.extend(t);C.bindPopup('<table class="table"><thead><tr><th style="border-bottom: 2px solid #ccc;"><h4 style="margin: 0;">Route: #'+l+'</h4></th><th style="border-bottom: 2px solid #ccc;">&nbsp;</th></tr></thead><tbody><tr><td style="padding-top: 5px;"><b>Direction:</b></td><td style="padding-top: 5px;">'+z[B][i].Direction.replace("Bound","bound")+"</td></tr><tr><td><b>Bus #:</b></td><td>"+z[B][i].VehicleID+"</td></tr>"+((z[B][i].destination!="")?"<tr><td><b>Destination:</b></td><td>"+z[B][i].destination+"</td></tr>":"")+'<tr><td><b>Updated:</b></td><td><i style="color:#d9534f; font-weight: 300;">'+method.parse_data.calc_time(z[B][i].Offset_sec)+"</i></td></tr></tbody></table>");j.push(C)}else{if(z[B][i].dest.toLowerCase().replace(/\s/g,"-")==l){g.addLayer(C);D.extend(t);C.bindPopup("<h4>Route: "+$('div[data-value="'+l+'"]').html()+'</h4><table class="table"><tbody><tr><td><b>Train #:</b></td><td>'+z[B][i].trainno+"</td></tr>"+((z[B][i].nextstop!="")?"<tr><td><b>Next Stop:</b>&nbsp;&nbsp;&nbsp;</td><td>"+z[B][i].nextstop+"</td></tr>":"")+((z[B][i].service!="")?"<tr><td><b>Service:</b></td><td>"+z[B][i].service+"</td></tr>":"")+'<tr><td><b>Late:</b></td><td><i style="'+((parseFloat(z[B][i].late)==0)?"color:#5cb85c":"color:#d9534f")+'; font-weight: 300;">'+((parseFloat(z[B][i].late)==0)?"On time":(z[B][i].late+" min"))+"</i></td></tr></tbody></table>");j.push(C)}}}g.addTo(c);if(A=="bus"||A=="trolley"){q.addTo(c);c.options.maxZoom=19}else{if(A=="train"){c.options.maxZoom=13}}setTimeout(function(){if(j.length>0){if(k){c.panTo(c.fitBounds(D).getCenter());k=false}}else{alert("Sorry, no results found");jQuery(".preloaderWrapper").hide();jQuery(".searchWrapper").show()}jQuery(".ui-autocomplete").hide()},100);jQuery(".preloaderWrapper").hide()},add_bus_lines:function(s,t){e=L.geoJson(s,{style:function(v,u){if(v.geometry.type!="Point"){if(t=="bus"){return{weight:3,color:"#999",opacity:0.8,fillColor:"#999",fillOpacity:0.5}}else{return{weight:3,color:"#5cb85c",opacity:0.8,fillColor:"#5cb85c",fillOpacity:0.5}}}},pointToLayer:function(u,v){return L.circleMarker(v,{radius:0})}}).addTo(c);d=[];if(typeof(a)=="object"){c.removeControl(a)}a=L.control({position:"topright"});a.onAdd=function(u){var v=L.DomUtil.create("div","info legend");v.innerHTML+='<table class="table"><tr class="nw_layer buttonItem" data-value="on"><td><img src="icons/bus_blue@2x.png" /></td><td class="nb"><span>North/West Bound</span</td></tr><tr class="se_layer buttonItem" data-value="on"><td><img src="icons/bus_orange@2x.png" /></td><td class="sb"><span>South/East Bound</span></td></tr><tr><td><input type="checkbox" id="show_stops"></td><td>Show all bus stops</td></tr></table>';return v};a.addTo(c);jQuery("#show_stops").on("click",function(){if(jQuery(this).prop("checked")){(d.length==0)?method.get_data.get_bus_stops(l):method.map.add_all_stops()}else{method.map.remove_layer(m)}});jQuery(".nw_layer").on("click",function(){if(jQuery(this).attr("data-value")=="on"){method.map.remove_layer(g);jQuery(this).attr("data-value","off")}else{g.addTo(c);jQuery(this).attr("data-value","on")}});jQuery(".se_layer").on("click",function(){if(jQuery(this).attr("data-value")=="on"){method.map.remove_layer(q);jQuery(this).attr("data-value","off")}else{q.addTo(c);jQuery(this).attr("data-value","on")}})},add_train_lines:function(s){r=L.geoJson(s,{style:function(u,t){if(u.geometry.type!="Point"){if(u.properties.name==l){return{weight:3,color:"#f0ad4e",opacity:0.8,fillColor:"#f0ad4e",fillOpacity:0.5}}else{return{weight:3,color:"#999",opacity:0.5,fillColor:"#999",fillOpacity:0}}}},pointToLayer:function(t,u){return L.circleMarker(u,{radius:0})}}).addTo(c);if(typeof(a)=="object"){c.removeControl(a)}a=L.control({position:"topleft"});a.onAdd=function(t){var u=L.DomUtil.create("div","info legend arrivalLegend");u.innerHTML+='<div class="arrivalLegendWrapper"><div class="arrivalLegendBTN buttonItem transitionAll"><span><i class="fa fa-calendar"></i></span></div><div class="arrivalInfoWrapper transitionAll"><div class="arrivalTitle transitionAll">Arrival Schedule</div><form class="form-inline"><div class="form-group"><input type="text" class="form-control" id="next_arrival_start" placeholder="Origin"></div><div class="form-group"><input type="text" class="form-control" id="next_arrival_end" placeholder="Destination"></div><button id="arrival_search" class="btn btn-primary transitionAll" type="button">Search</button></form><div class="arrivalTableWrapper"><div class="spinnerWrapper"></div><table class="table arrivalTable"></table></div></div></div>';L.DomEvent.disableClickPropagation(u);return u};a.addTo(c);jQuery(".arrivalLegendBTN").unbind("click");jQuery(".arrivalLegendBTN").on("click",function(){method.map.train_schedule()});jQuery("#arrival_search").unbind("click").prop("disabled",true);jQuery("#arrival_search").on("click",function(){if(jQuery("#next_arrival_start").val()!=""&&jQuery("#next_arrival_end").val()!=""){method.get_data.arrival_times(jQuery("#next_arrival_start").val(),jQuery("#next_arrival_end").val())}else{(jQuery("#next_arrival_start").val()!="")?alert("Enter Origin"):alert("Enter Destination")}});jQuery("#next_arrival_end").unbind();jQuery("#next_arrival_end").on("input",function(){if(jQuery(this).val().length>0){jQuery("#arrival_search").prop("disabled",false)}}).on("keydown",function(t){if(t.keyCode==13){jQuery("#arrival_search").click()}})},add_all_stops:function(){m=new L.LayerGroup();m.clearLayers();for(i in d){var s=L.circle([d[i].lat,d[i].lng],12,{color:"#c9302c",fillColor:"#d9534f",fillOpacity:0.85});m.addLayer(s);s.bindPopup(d[i].stopname)}m.addTo(c)},add_found_stops:function(y){g=new L.LayerGroup();var t=L.Icon.extend({options:{iconSize:[25,41],shadowSize:[41,41],iconAnchor:[12.5,41],shadowAnchor:[12.5,41],popupAnchor:[0,-33],shadowUrl:"icons/marker-shadow.png",shadowRetinaUrl:"icons/marker-shadow@2x.png",shadowSize:[41,41]}}),z=new t({iconUrl:"icons/bus_found_stop.png",iconRetinaUrl:"icons/bus_found_stop@2x.png"}),v=new t({iconUrl:"icons/train_found_stop.png",iconRetinaUrl:"icons/train_found_stop@2x.png"}),s=new t({iconUrl:"icons/trolley_found_stop.png",iconRetinaUrl:"icons/trolley_found_stop@2x.png"}),u=new L.LatLngBounds();for(i in y){if((y[i].location_type=="bus_stops"||y[i].location_type=="rail_stations"||y[i].location_type=="trolley_stops")&&(y[i].location_lat!=""&&y[i].location_lon!="")){var w=L.marker([y[i].location_lat,y[i].location_lon],{id:i,icon:((y[i].location_type=="bus_stops")?z:((y[i].location_type=="rail_stations")?v:s))}),x=new L.LatLng(y[i].location_lat,y[i].location_lon);g.addLayer(w);u.extend(x);w.bindPopup("<h4>"+y[i].location_name+'</h4><table class="table"><tbody><tr><td style="padding-top: 5px;"><b>Type:</b></td><td style="padding-top: 5px;">'+y[i].location_type.replace("bus","Bus").replace("trolley","Trolley").replace("_stops"," stop").replace("rail","Train").replace("_stations"," station")+'</td></tr><tr><td><b>Distance:</b></td><td><i style="color:#d9534f; font-weight: 300;">'+y[i].distance+" miles</i></td></tr></tbody></table>");j.push(w)}}c.options.maxZoom=19;g.addTo(c);setTimeout(function(){c.panTo(c.fitBounds(u).getCenter())},100);jQuery(".preloaderWrapper").hide()},train_schedule:function(){if(jQuery(".arrivalInfoWrapper").hasClass("arrivalInfoWrapperActive")){jQuery(".arrivalInfoWrapper").removeClass("arrivalInfoWrapperActive").slideUp()}else{jQuery(".arrivalInfoWrapper").addClass("arrivalInfoWrapperActive").slideDown()}},remove_layer:function(s){c.removeLayer(s)},clear_all:function(){if(l!=null){clearTimeout(b);if(typeof(g)=="object"){method.map.remove_layer(g)}if(typeof(q)=="object"){method.map.remove_layer(q)}if(typeof(e)=="object"){method.map.remove_layer(e)}if(typeof(r)=="object"){method.map.remove_layer(r)}if(typeof(m)=="object"){method.map.remove_layer(m)}if(typeof(a)=="object"){c.removeControl(a)}d=[];j=[];l="";a="";k=true}}},get_data:{find_route_type:function(t,s){jQuery(".ui-autocomplete").hide();if(jQuery.inArray(t.toLowerCase(),h)!=-1){method.map.clear_all();jQuery("#menu_wrapper").removeClass("menuWrapperActive");l=t;k=true;method.update_anchor_tag(l);method.get_data.get_rail_line();method.get_data.get_rail_data()}else{if(jQuery.inArray(t.toLowerCase(),o)!=-1||jQuery.inArray(t.toLowerCase(),p)!=-1){method.map.clear_all();jQuery("#menu_wrapper").removeClass("menuWrapperActive");l=t;k=true;method.update_anchor_tag(l);method.get_data.get_bus_line(((jQuery.inArray(t.toLowerCase(),o)!=-1)?"bus":"trolley"));method.get_data.get_bus_data(((jQuery.inArray(t.toLowerCase(),o)!=-1)?"bus":"trolley"))}else{k=false;if(s){alert("Sorry, that route doesn't exist");l=null;method.update_anchor_tag(l)}else{jQuery(".preloaderWrapper").hide();jQuery(".searchWrapper").show();method.update_anchor_tag(null)}}}},get_bus_data:function(t){jQuery(".preloaderWrapper").show();jQuery(".searchWrapper").hide();jQuery("#menu_wrapper").removeClass("menuWrapperActive");var s=((new Date).getTime());jQuery.ajax({url:"http://www3.septa.org/hackathon/TransitView/?route="+l+"&ts="+s+"&callback=?",dataType:"json",success:function(u){method.map.add_points(u,t);method.timer.start();b=setTimeout(function(){method.map.remove_layer(g);method.map.remove_layer(q);if(l!=null){method.get_data.get_bus_data(t)}},60000)},error:function(){alert("Sorry, something went wrong");jQuery(".preloaderWrapper").hide();jQuery(".searchWrapper").show()}})},get_bus_line:function(s){jQuery.ajax({url:"routes/routes_"+l+".kml",dataType:"text",success:function(t){method.map.add_bus_lines(toGeoJSON.kml(jQuery.parseXML(t)),s)},error:function(){alert("Sorry, something went wrong")}})},get_bus_stops:function(){jQuery(".preloaderWrapper").show();jQuery.ajax({url:"http://www3.septa.org/hackathon/Stops/?req1="+l+"&callback=?",dataType:"json",success:function(s){jQuery(".preloaderWrapper").hide();d=s;method.map.add_all_stops()},error:function(){alert("Sorry, something went wrong")}})},get_rail_data:function(){jQuery(".preloaderWrapper").show();jQuery(".searchWrapper").hide();jQuery("#menu_wrapper").removeClass("menuWrapperActive");var s=((new Date).getTime());jQuery.ajax({url:"http://www3.septa.org/hackathon/TrainView/?dm="+l+"&ts="+s+"&callback=?",dataType:"json",success:function(u){var t={};t.train=u;method.map.add_points(t,"train");method.timer.start();b=setTimeout(function(){method.map.remove_layer(g);if(l!=null){method.get_data.get_rail_data()}},60000)},error:function(){alert("Sorry, something went wrong");jQuery(".preloaderWrapper").hide();jQuery(".searchWrapper").show()}})},get_rail_line:function(){jQuery.ajax({url:"routes/regional_rail.kml",dataType:"text",success:function(s){method.map.add_train_lines(toGeoJSON.kml(jQuery.parseXML(s)))},error:function(){alert("Sorry, something went wrong")}})},find_stations:function(u,t){jQuery(".preloaderWrapper").show();jQuery(".searchWrapper").hide();jQuery("#menu_wrapper").removeClass("menuWrapperActive");method.map.clear_all();method.update_anchor_tag(null);var s=((new Date).getTime());jQuery.ajax({url:"http://www3.septa.org/hackathon/locations/get_locations.php?lon="+t+"&lat="+u+"&callback=?&radius=3",dataType:"jsonp",success:function(v){method.map.add_found_stops(v)},error:function(){alert("Sorry, something went wrong")}})},arrival_times:function(t,s){jQuery(".arrivalTableWrapper").show();jQuery(".arrivalTable").empty();jQuery.ajax({url:"http://www3.septa.org/hackathon/NextToArrive/?req1="+method.parse_data.capitalize_first_letter(t)+"&req2="+method.parse_data.capitalize_first_letter(s)+"&req3=5&callback=?",dataType:"json",success:function(v){jQuery(".spinnerWrapper").slideUp(150);jQuery(".arrivalTable").slideDown(150);if(v.length==0){jQuery(".arrivalTable").html('<tr style="position: relative; text-align: center;"><td style="font-weight: 700; color: #d9534f">No Results Found</td></tr>')}else{jQuery(".arrivalTable").html("<tr><th>Line</th><th>Departure</th><th>Arrival</th><th>Late</th></tr>");for(var u in v){jQuery(".arrivalTable").append("<tr><td>"+v[u].orig_line+"</td><td>"+v[u].orig_departure_time+"</td><td>"+v[u].orig_arrival_time+'</td><td><span class="badge badge-'+((v[u].orig_delay.toLowerCase()=="on time")?"success":"danger")+'">'+((v[u].orig_delay.toLowerCase()=="on time")?"0 min":v[u].orig_delay)+"</span></td></tr>")}}},error:function(){jQuery(".spinnerWrapper").slideUp(150);jQuery(".arrivalTable").slideDown(150);jQuery(".arrivalTable").html("No Results Found")}})}},parse_data:{calc_time:function(s){var t=Math.floor(s/60);if(t==0){return"Less than 1 min ago"}return t+" min "+(Math.round(Math.floor(100*(((s/60)%1)*60))/100)).toString()+" sec ago"},capitalize_first_letter:function(s){return s.toLowerCase().replace(/\b\w/g,function(t){return t.toUpperCase()})}},geocode:{google:function(t){jQuery(".preloaderWrapper").show();jQuery(".searchWrapper").hide();jQuery("#menu_wrapper").removeClass("menuWrapperActive");if(!f){var u=document.createElement("script");u.type="text/javascript";u.src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&callback=gmap_draw";window.gmap_draw=function(){geocoder=new google.maps.Geocoder();geocoder.geocode({address:(t+"Philadelphia, Pa")},function(v,s){if(s==google.maps.GeocoderStatus.OK){method.get_data.find_stations(v[0].geometry.location.A,v[0].geometry.location.F)}else{alert("Geocode was not successful for the following reason: "+s)}});f=true};jQuery("head").append(u)}}},timer:{start:function(){if(jQuery("#timer").data("pietimer")){jQuery("#timer").pietimer("reset");jQuery("#timer").pietimer("start")}else{jQuery("#timer").pietimer({timerSeconds:60,fill:false,showPercentage:false,callback:function(){jQuery("#timer").pietimer("reset");jQuery("#timer").pietimer("start")}})}}}};return method})();(function(b){b.fn.pietimer=function(c){if(a[c]){return a[c].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof c==="object"||!c){return a.init.apply(this,arguments)}else{b.error("Method "+c+" does not exist on jQuery.pietimer")}}};var a={init:function(c){var d={timer:null,timerSeconds:10,callback:function(){},timerCurrent:0,showPercentage:false,fill:false,color:"#337ab7"};d=b.extend(d,c);return this.each(function(){var f=b(this);var e=f.data("pietimer");if(!e){f.addClass("pietimer");f.css({fontSize:f.width()});f.data("pietimer",d);if(d.showPercentage){f.find(".percent").show()}if(d.fill){f.addClass("fill")}f.pietimer("start")}})},stopWatch:function(){var d=b(this).data("pietimer");if(d){var e=(d.timerFinish-(new Date().getTime()))/1000;if(e<=0){clearInterval(d.timer);b(this).pietimer("drawTimer",100);d.callback()}else{var c=100-((e/(d.timerSeconds))*100);b(this).pietimer("drawTimer",c)}}},drawTimer:function(d){$this=b(this);var e=$this.data("pietimer");if(e){$this.html('<div class="percent"></div><div class="slice'+(d>50?' gt50"':'"')+'><div class="pie"></div>'+(d>50?'<div class="pie fill"></div>':"")+"</div>");var c=360/100*d;$this.find(".slice .pie").css({"-moz-transform":"rotate("+c+"deg)","-webkit-transform":"rotate("+c+"deg)","-o-transform":"rotate("+c+"deg)",transform:"rotate("+c+"deg)"});$this.find(".percent").html(Math.round(d)+"%");if(e.showPercentage){$this.find(".percent").show()}if($this.hasClass("fill")){$this.find(".slice .pie").css({backgroundColor:e.color})}else{$this.find(".slice .pie").css({borderColor:e.color})}}},start:function(){var c=b(this).data("pietimer");if(c){c.timerFinish=new Date().getTime()+(c.timerSeconds*1000);b(this).pietimer("drawTimer",0);c.timer=setInterval("$this.pietimer('stopWatch')",50)}},reset:function(){var c=b(this).data("pietimer");if(c){clearInterval(c.timer);b(this).pietimer("drawTimer",0)}}}})(jQuery);